@using EventPad.Web.Pages.Users.Models
@using EventPad.Web.Pages.Users.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject IUserService userService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider authenticationStateProvider

@if (IsAuthenticated)
{
    <MudNavMenu Color="Color.Inherit" Icon="@Icons.Material.Filled.Face" AnchorOrigin="Origin.BottomRight">
        <MudNavLink Href="/profile" Match="NavLinkMatch.All">Profile</MudNavLink>
        <MudNavLink Href="/events" Match="NavLinkMatch.Prefix">Events</MudNavLink>
        <MudNavLink Href="/tickets" Match="NavLinkMatch.Prefix">Tickets</MudNavLink>
        <MudNavLink Href="/logout">Logout</MudNavLink>
    </MudNavMenu>
}
else
{
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="NavigateToLogin">Sign In</MudButton>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Large" OnClick="NavigateToRegister">Sign Up</MudButton>
}



@code {

    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter] public Guid? UserId { get; set; }

    [Parameter] public UserModel Model { get; set; } = new();

    private MudForm form = default!;

    private List<UserModel> Users { get; set; } = new List<UserModel>();

    private bool IsAuthenticated { get; set; }


    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        IsAuthenticated = user.Identity.IsAuthenticated;

        var owners = await userService.GetUsers();
        Users.AddRange(owners);


        if (UserId != null)
        {
            var model = await userService.GetUser(UserId.Value);

            Model.Id = model.Id;
            Model.FirstName = model.FirstName;
            Model.SecondName = model.SecondName;
            Model.Email = model.Email;
            Model.Rating = model.Rating;
        }
    }

    async Task Submit()
    {
        await form.Validate();
        if (form.IsValid)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void NavigateToLogin()
    {
        navigationManager.NavigateTo("/login");
    }

    private void NavigateToRegister()
    {
        navigationManager.NavigateTo("/register");
    }

    void Cancel() => MudDialog.Cancel();
}
